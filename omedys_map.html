<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>R√©seau Omedys</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root { --primary: #009597; --dark: #2d3748; --glass: rgba(255, 255, 255, 0.95); }
        body { margin: 0; padding: 0; height: 100vh; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* Recherche */
        #search-container { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 500px; height: 54px;
            background: var(--glass); backdrop-filter: blur(10px);
            border-radius: 50px; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            display: flex; align-items: center; padding: 0 6px 0 22px; z-index: 1000;
        }
        #search-container input { flex: 1; border: none; background: transparent; outline: none; font-size: 16px; }
        #search-button { background: var(--primary); width: 42px; height: 42px; border-radius: 50%; border: none; cursor: pointer; display: grid; place-items: center; }
        
        /* Menu Filtres */
        #filter-toggle {
            position: absolute; bottom: 30px; right: 20px; background: var(--primary); width: 60px; height: 60px; 
            border-radius: 50%; border: none; cursor: pointer; display: grid; place-items: center; z-index: 1100;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        #side-menu {
            position: absolute; top: 0; right: -320px; width: 280px; height: 100vh;
            background: white; z-index: 1050; transition: right 0.3s; padding: 40px 25px; box-sizing: border-box;
        }
        #side-menu.open { right: 0; }
        .filter-item { display: flex; align-items: center; gap: 12px; margin-bottom: 15px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .dot { width: 12px; height: 12px; border-radius: 50%; border: 1.5px solid white; box-shadow: 0 0 0 1px #ddd; }
        #menu-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.2); z-index: 1040; display: none; }
        #menu-overlay.open { display: block; }

        /* Popups */
        .popup-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .type-badge { background: #edf2f7; color: #4a5568; padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 800; text-transform: uppercase; border: 1px solid #e2e8f0; }
        .status-badge { color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold; }
        .tel-link {
            display: flex; align-items: center; gap: 8px; margin-top: 10px; padding: 8px 12px;
            background: #f0fdfa; color: var(--primary); text-decoration: none; font-weight: bold;
            border-radius: 8px; font-size: 13px; border: 1px solid #ccfbf1;
        }
    </style>
</head>
<body>

    <div id="search-container">
        <select id="geo-select" onchange="rechercheSelection(this.value)" 
            style="width: 100%; border: none; background: transparent; font-size: 16px; outline: none; padding: 10px; cursor: pointer;">
            <option value="">Chargement des zones...</option>
        </select>
    </div>

    <button id="filter-toggle" onclick="toggleMenu()">
        <svg width="28" height="28" fill="white" viewBox="0 0 24 24"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"/></svg>
    </button>

    <div id="menu-overlay" onclick="toggleMenu()"></div>
    <div id="side-menu">
        <h2 style="color:var(--primary); margin-top:0;">Filtres</h2>
        <div id="filter-list"></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false }).setView([46.6033, 1.8883], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let highlightLayer = null; // Calque pour la surbrillance (G√©oJSON)
        let allMarkers = [];

        const statusSettings = {
            "Ouvert": { color: "#009597", label: "Cabinet Omedys", active: true },
            "Ouvertes": { color: "#2ecc71", label: "Salles Ouvertes", active: true },
            "Telesecretariat OMEDYS": { color: "#8956FB ", label: "Telesecretariat OMEDYS", active: true },
            "Ouverture en cours": { color: "#3498db", label: "En cours", active: true },
            "En sourcing": { color: "#f1c40f", label: "Sourcing", active: true },
            "Salles inactives": { color: "#95a5a6", label: "Inactif", active: true },
            "Fermees ou refus OTT": { color: "#e74c3c", label: "Ferm√© / Refus", active: true }
        };

        function toggleMenu() {
            document.getElementById('side-menu').classList.toggle('open');
            document.getElementById('menu-overlay').classList.toggle('open');
        }

        async function chargerListeZones() {
            try {
                const response = await fetch('zones.json');
                const data = await response.json();
                const select = document.getElementById('geo-select');
                
                let html = '<option value="">üìç Choisir une R√©gion ou un D√©partement</option>';
                
                // Cat√©gorie R√©gions
                html += '<optgroup label="R√©gions">';
                data.regions.forEach(reg => {
                    html += `<option value="reg:${reg.code}">${reg.nom}</option>`;
                });
                html += '</optgroup>';
        
                // Cat√©gorie D√©partements
                html += '<optgroup label="D√©partements">';
                data.departements.forEach(dep => {
                    html += `<option value="dep:${dep.code}">${dep.code} - ${dep.nom}</option>`;
                });
                html += '</optgroup>';
        
                select.innerHTML = html;
            } catch (err) {
                console.error("Impossible de charger zones.json :", err);
            }
        }
        
        // Lancer le chargement au d√©marrage
        chargerListeZones();
        
        // Fonction de zoom et surbrillance
        async function rechercheSelection(valeur) {
            if (!valeur) return;
        
            // Supprimer l'ancienne surbrillance bleue
            if (highlightLayer) {
                map.removeLayer(highlightLayer);
                highlightLayer = null;
            }
        
            const [type, code] = valeur.split(':');
            const endpoint = type === 'dep' ? 'departements' : 'regions';
            const url = `https://geo.api.gouv.fr/${endpoint}/${code}?format=geojson&geometry=contour`;
        
            try {
                const res = await fetch(url).then(r => r.json());
                highlightLayer = L.geoJSON(res, {
                    style: { color: "#009597", weight: 3, fillColor: "#009597", fillOpacity: 0.15 }
                }).addTo(map);
                
                map.flyToBounds(highlightLayer.getBounds(), { padding: [30, 30], duration: 1.5 });
            } catch (err) {
                console.error("Erreur API G√©o :", err);
            }
        }
        
        function showGeoJson(data) {
            highlightLayer = L.geoJSON(data, {
                style: {
                    color: "#009597",
                    weight: 3,
                    fillColor: "#009597",
                    fillOpacity: 0.15
                }
            }).addTo(map);
            
            map.flyToBounds(highlightLayer.getBounds(), { padding: [30, 30], duration: 1.5 });
        }

        // --- Fonctions existantes Omedys (JSON et Marqueurs) ---

        function extractData(json) {
            if (Array.isArray(json) && json[0]?.data) return json[0].data;
            if (json?.data) return json.data;
            return Array.isArray(json) ? json : [];
        }

        async function chargerDonnees() {
            try {
                const [resSalles, resCabinets] = await Promise.all([
                    fetch('salles.json').then(r => r.json()),
                    fetch('cabinet.json').then(r => r.json())
                ]);
                creerMarqueurs([...extractData(resSalles), ...extractData(resCabinets)]);
            } catch (err) { console.error("Erreur JSON:", err); }
        }

        function creerMarqueurs(data) {
            data.forEach(item => {
                const lat = parseFloat(item.Latitude);
                const lng = parseFloat(item.Longitude);
                if (isNaN(lat) || isNaN(lng)) return;

                const status = (item.Statut || "Inconnu").trim();
                const typeEtab = (item.Type || "√âtablissement").trim();
                const color = statusSettings[status]?.color || "#7f8c8d";

                const marker = L.circleMarker([lat, lng], {
                    radius: item.Type === "CABINET" ? 9 : 6,
                    fillColor: color, color: "#fff", weight: 2, fillOpacity: 0.9
                }).addTo(map);

                let popupHtml = `
                    <div class="popup-card">
                        <div class="popup-header">
                            <span class="type-badge">${typeEtab}</span>
                            <span class="status-badge" style="background:${color}">${status}</span>
                        </div>
                        <b style="color:var(--primary); font-size:15px; display:block;">${item.Name}</b>
                        <div style="font-size:12px; color:#4a5568; margin: 5px 0;">${item.Address || ""}</div>`;
                
                if (item.Phone) {
                    const cleanTel = item.Phone.toString().replace(/\D/g, '');
                    const formattedTel = cleanTel.match(/.{1,2}/g)?.join(' ') || item.Phone;
                    popupHtml += `<a href="tel:${cleanTel}" class="tel-link">${formattedTel}</a>`;
                }
                
                marker.bindPopup(popupHtml + `</div>`);
                allMarkers.push({ marker, status });
            });
            initMenu();
        }

        function initMenu() {
            const list = document.getElementById('filter-list');
            list.innerHTML = Object.keys(statusSettings).map(s => `
                <label class="filter-item">
                    <input type="checkbox" checked onclick="toggleStatus('${s}', this.checked)">
                    <span class="dot" style="background:${statusSettings[s].color}"></span> ${statusSettings[s].label}
                </label>
            `).join('');
        }

        window.toggleStatus = (s, v) => {
            allMarkers.forEach(m => { if (m.status === s) v ? m.marker.addTo(map) : map.removeLayer(m.marker); });
        };

        chargerDonnees();
    </script>
</body>
</html>








