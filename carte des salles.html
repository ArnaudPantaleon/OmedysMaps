<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Carte des Salles & Cabinets</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; height: 100vh; font-family: 'Segoe UI', sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
        }

        /* Barre de recherche */
        #search-container { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%); 
            width: 90%; max-width: 500px; padding: 8px 20px;
        }
        #search-container input { flex: 1; border: none; background: transparent; outline: none; padding: 10px; font-size: 16px; }
        #search-container button { background: #6c5ce7; color: white; border: none; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: bold; }

        /* Menu du bas */
        #bottom-menu {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 10px 25px; gap: 15px; white-space: nowrap;
        }

        .filter-item { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; cursor: pointer; color: #2c3e50; }
        .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }

        /* STYLE SPECIAL CABINET : Plus gros */
        .cabinet-pin {
            background: #009597;
            width: 22px !important;
            height: 22px !important;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .card-title { color: #6c5ce7; font-size: 1.1em; font-weight: bold; border-bottom: 2px solid #eee; margin-bottom: 8px; display: block; padding-bottom: 5px; }
    </style>
</head>
<body>

    <div id="search-container" class="glass-panel">
        <input type="text" id="query" placeholder="Rechercher une ville..." onkeypress="if(event.key === 'Enter') rechercheEtZoom()">
        <button onclick="rechercheEtZoom()">Chercher</button>
    </div>

    <div id="bottom-menu" class="glass-panel"></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>

// Configuration des statuts
const statusSettings = {
    "Salles ouvertes": { color: "#2ed573", active: true },
    "Salles ouvertes t√©l√©secr√©tariat OMEDYS": { color: "#1dd1a1", active: true },
    "Ouverture en cours": { color: "#1e90ff", active: true },
    "Salles en sourcing": { color: "#ffa502", active: true },
    "Salles ferm√©es ou refus OTT": { color: "#ff4757", active: true },
    "Salles Inactives": { color: "#a4b0be", active: true }
};

let allMarkers = [];
let showEhpad = true;

const map = L.map('map', { zoomControl: false }).setView([46.6033, 1.8883], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// Fonction de formatage t√©l√©phone
function formaterTel(tel) {
    if (!tel) return "";
    let clean = tel.toString().replace(/\D/g, '');
    if (clean.startsWith('33')) clean = '0' + clean.slice(2);
    if (clean.length === 9 && !clean.startsWith('0')) clean = '0' + clean;
    return clean.match(/.{1,2}/g) ? clean.match(/.{1,2}/g).join(' ') : clean;
}

// FONCTION DE CHARGEMENT
async function chargerDonnees() {
    try {
        const resSalles = await fetch('https://files.support-omedys.fr/seafhttp/f/642574d0a0f64f849d46/?op=view');
        const resCabinets = await fetch('https://files.support-omedys.fr/seafhttp/f/82dc73ecccaa4687a31b/?op=view');
        
        const salles = await resSalles.json();
        const cabinets = await resCabinets.json();

        // Fusion des donn√©es
        const totalData = [...salles, ...cabinets];
        
        creerMarqueurs(totalData);
    } catch (err) {
        console.error("Erreur de chargement JSON:", err);
    }
}

function creerMarqueurs(data) {
    data.forEach(item => {
        const lat = parseFloat(item.Latitude);
        const lng = parseFloat(item.Longitude);

        if (!isNaN(lat) && !isNaN(lng)) {
            const statusKey = item.Statut || "";
            const isCabinet = (item.Type === "CABINET");
            const isEhpad = (item.Name || "").toLowerCase().includes("ehpad");
            const telAffiche = formaterTel(item.Phone);

            let marker;
            if (isCabinet) {
                const colorCab = (statusKey === "Ouvert") ? "#009597" : "#1e90ff";
                marker = L.marker([lat, lng], { 
                    icon: L.divIcon({ 
                        className: 'cabinet-pin',
                        html: `<div style="background:${colorCab}; width:100%; height:100%; border-radius:50%;"></div>`
                    }),
                    zIndexOffset: 1000 
                });
            } else {
                const config = statusSettings[statusKey] || { color: "#333" };
                marker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        html: `<div style="background:${config.color}; width:12px; height:12px; border-radius:50%; border:2px solid white;"></div>`,
                        className: ""
                    })
                });
            }

            let popupContent = `<b class="card-title" style="color:${isCabinet ? '#009597' : '#333'}">${item.Name}</b>`;
            popupContent += `<div style="font-size:13px; margin-bottom:5px;">${item.Adresse}</div>`;
            if (telAffiche) popupContent += `<div style="font-size:13px; margin-bottom:5px;"><b>T√©l :</b> ${telAffiche}</div>`;
            
            if (isCabinet) {
                popupContent += `<b style="color:#009597;">üè† Cabinet R√©f√©rent</b>`;
            } else if (item["Cabinet(s) m√©dical(aux) TMS"]) {
                popupContent += `<div style="font-size:12px; color:#666; margin-top:5px;"><b>TMS :</b> ${item["Cabinet(s) m√©dical(aux) TMS"]}</div>`;
            }

            marker.bindPopup(popupContent);
            allMarkers.push({ marker, status: statusKey, isEhpad, isCabinet });
        }
    });
    refreshDisplay();
}

function refreshDisplay() {
    allMarkers.forEach(m => {
        const statusActive = statusSettings[m.status] ? statusSettings[m.status].active : true;
        if (m.isCabinet || (statusActive && (showEhpad || !m.isEhpad))) {
            if (!map.hasLayer(m.marker)) m.marker.addTo(map);
        } else {
            if (map.hasLayer(m.marker)) map.removeLayer(m.marker);
        }
    });
}

function initMenu() {
    const menu = document.getElementById('bottom-menu');
    let html = Object.keys(statusSettings).map(s => `
        <label class="filter-item">
            <input type="checkbox" checked onclick="toggleStatus('${s}', this.checked)">
            <span class="dot" style="background:${statusSettings[s].color}"></span> ${s.replace("Salles ", "")}
        </label>
    `).join('');
    html += `<div style="width:1px; height:20px; background:#ddd; margin:0 10px;"></div>`;
    html += `<label class="filter-item"><input type="checkbox" checked onclick="toggleEhpad(this.checked)"> EHPAD</label>`;
    menu.innerHTML = html;
}

window.toggleStatus = (s, v) => { statusSettings[s].active = v; refreshDisplay(); };
window.toggleEhpad = (v) => { showEhpad = v; refreshDisplay(); };

function rechercheEtZoom() {
    const v = document.getElementById('query').value;
    fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(v)}&limit=1`)
        .then(r => r.json()).then(res => {
            if (res.features.length > 0) {
                const [lon, lat] = res.features[0].geometry.coordinates;
                map.flyTo([lat, lon], 13);
            }
        });
}

initMenu();
chargerDonnees();
    </script>
</body>
</html>